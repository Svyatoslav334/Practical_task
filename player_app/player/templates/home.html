<!DOCTYPE html>
<html lang="uk">
<head>
    <title>SoundCloud Music Player</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: white;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
        }
        .player-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: block; 
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .custom-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .artwork {
            width: 200px;
            height: 200px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .artwork.playing {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.05) rotate(1deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .track-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .track-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .track-artist {
            opacity: 0.8;
            font-size: 0.9em;
        }
        .progress-container {
            width: 100%;
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d);
            border-radius: 5px;
            width: 0%;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .play-btn {
            background: #ff6b6b;
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .play-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }
        .play-btn.playing {
            background: #4caf50;
        }
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .volume-slider {
            width: 100px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            outline: none;
            background: linear-gradient(90deg, #ffd93d, #ff6b6b);
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
        .track-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        .track-link {
            color: #fff;
            text-decoration: none;
            padding: 10px;
            display: block;
            border-radius: 8px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .track-link:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .track-link img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
        }
        .btn-open-player {
            background: #ff6b6b;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 10px;
            transition: background 0.3s;
        }
        .btn-open-player:hover {
            background: #ff5252;
        }
        .error-message {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .no-results {
            color: #ccc;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container text-center text-white">
        <h1 class="mb-4">ðŸŽµ SoundCloud Music Player</h1>

        {% if user.is_authenticated %}
            <p class="mb-3">Ð’Ñ–Ñ‚Ð°ÑŽ, **{{ user.username }}**!</p>
            <a href="/logout/" class="btn btn-outline-light mb-3">Ð’Ð¸Ð¹Ñ‚Ð¸</a>
            
            <form method="GET" action="{% url 'home' %}" class="d-flex justify-content-center mb-4">
                <input type="text" name="q" class="form-control me-2" placeholder="Ð’Ð²ÐµÐ´Ð¸ Ð½Ð°Ð·Ð²Ñƒ Ñ‚Ñ€ÐµÐºÑƒ" value="{{ query|default:'' }}" {% if query %}required{% endif %}>
                <button type="submit" class="btn btn-primary">ÐŸÐ¾ÑˆÑƒÐº</button>
            </form>

            {% if query %}
                <h3 class="mb-3">Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸ Ð¿Ð¾ÑˆÑƒÐºÑƒ: "{{ query }}"</h3>
                <div class="track-list">
                    {% if tracks %}
                        <ul class="list-unstyled">
                            {% for t in tracks %}
                                <li>
                                    <a href="#" class="track-link" 
                                       data-track-url="https://api.soundcloud.com/tracks/{{ t.id }}"
                                       data-title="{{ t.title|escapejs }}"
                                       data-artist="{{ t.user.username|escapejs }}"
                                       data-artwork="{{ t.artwork_url|default:'https://via.placeholder.com/200?text=No+Art' }}">
                                        <img src="{{ t.artwork_url|default:'https://via.placeholder.com/40?text=Art' }}" alt="Artwork" onerror="this.src='https://via.placeholder.com/40?text=Art'">
                                        <div>
                                            <div>{{ t.title }}</div>
                                            <small class="opacity-75">{{ t.user.username }}</small>
                                        </div>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="no-results">Ð¢Ñ€ÐµÐºÑ–Ð² Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾</div>
                    {% endif %}
                </div>
            
            {% endif %}

            {% if error %}
                <div class="error-message">{{ error }}</div>
            {% endif %}

            <div id="player-container" class="player-container">
                <div class="custom-player">
                    <div class="artwork" id="artwork" style="background-image: url('https://via.placeholder.com/200?text=Select+Track');"></div>
                    <div class="track-info">
                        <div class="track-title" id="track-title">ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ñ‚Ñ€ÐµÐº</div>
                        <div class="track-artist" id="track-artist"></div>
                    </div>
                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="time-display">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                    <div class="controls">
                        <button id="play-btn" class="play-btn">â–¶</button>
                        <div class="volume-container">
                            <span>ðŸ”Š</span>
                            <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="50">
                        </div>
                    </div>
                </div>
                <iframe id="sc-widget" 
                        src="https://w.soundcloud.com/player/?url=https://api.soundcloud.com/tracks/1848538&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"
                        allow="autoplay"></iframe>
            </div>
        {% else %}
            <a href="/auth/login/soundcloud/" class="btn btn-light btn-lg">Ð£Ð²Ñ–Ð¹Ñ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· SoundCloud</a>
        {% endif %}
    </div>

<script src="https://w.soundcloud.com/player/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const openOfficialPlayerBtn = document.getElementById('open-official-player-btn');
        const officialPlayerDisplay = document.getElementById('official-player-display');
        const officialScWidget = document.getElementById('official-sc-widget');
        
        const widgetIframe = document.getElementById('sc-widget');
        const playBtn = document.getElementById('play-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const volumeSlider = document.getElementById('volume-slider');
        const artworkEl = document.getElementById('artwork');
        const trackTitleEl = document.getElementById('track-title');
        const trackArtistEl = document.getElementById('track-artist');

        let widget = null;
        let currentTrack = null;
        let duration = 0;
        
        if (widgetIframe) {
            widget = SC.Widget(widgetIframe);
        }

        function formatTime(seconds) {
            if (seconds == null || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateProgress(position, dur) {
            if (dur <= 0) return;
            const percent = (position / dur) * 100;
            progressBar.style.width = `${percent}%`;
            currentTimeEl.textContent = formatTime(position / 1000);
            durationEl.textContent = formatTime(dur / 1000);
        }

        if (widget) {
            widget.bind(SC.Widget.Events.READY, function() {
                console.log('Widget ready');
                widget.setVolume(volumeSlider.value / 100);
            });

            widget.bind(SC.Widget.Events.PLAY, function() {
                playBtn.classList.add('playing');
                playBtn.innerHTML = 'â¸';
                artworkEl.classList.add('playing');
                widget.getDuration(function(dur) {
                    duration = dur;
                    durationEl.textContent = formatTime(duration / 1000);
                });
            });

            widget.bind(SC.Widget.Events.PAUSE, function() {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = 'â–¶';
                artworkEl.classList.remove('playing');
            });

            widget.bind(SC.Widget.Events.PLAY_PROGRESS, function(e) {
                if (e && e.currentPosition !== undefined && duration > 0) { 
                    updateProgress(e.currentPosition, duration);
                }
            });

            widget.bind(SC.Widget.Events.FINISH, function() {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = 'â–¶';
                artworkEl.classList.remove('playing');
                progressBar.style.width = '0%';
                currentTimeEl.textContent = '0:00';
            });

            widget.bind(SC.Widget.Events.LOAD_PROGRESS, function(e) {
                if (e && e.duration) {
                    duration = e.duration;
                    durationEl.textContent = formatTime(duration / 1000);
                }
            });
        }

        playBtn.addEventListener('click', function() {
            if (widget && currentTrack) {
                widget.toggle();
            } else {
                alert('Ð‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, Ð¾Ð±ÐµÑ€Ñ–Ñ‚ÑŒ Ñ‚Ñ€ÐµÐº Ð·Ñ– ÑÐ¿Ð¸ÑÐºÑƒ, Ñ‰Ð¾Ð± Ð¿Ð¾Ñ‡Ð°Ñ‚Ð¸ Ð²Ñ–Ð´Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ.');
            }
        });

        volumeSlider.addEventListener('input', function() {
            if (widget) {
                widget.setVolume(this.value / 5); 
            }
        });

        progressContainer.addEventListener('click', function(e) {
            if (widget && duration > 0) {
                const rect = this.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const seekTime = percent * duration;
            
                widget.seekTo(seekTime);
                progressBar.style.width = `${percent * 100}%`;
                currentTimeEl.textContent = formatTime(seekTime / 1000);
            }
        });

        document.querySelectorAll('.track-link').forEach(el => {
            el.addEventListener('click', function(event) {
                event.preventDefault();
                const trackUrl = this.dataset.trackUrl;
                const title = this.dataset.title;
                const artist = this.dataset.artist;
                const artwork = this.dataset.artwork;

                if (!trackUrl || !widget) return;

                currentTrack = { url: trackUrl, title, artist, artwork };
                trackTitleEl.textContent = title;
                trackArtistEl.textContent = artist;
                artworkEl.style.backgroundImage = `url('${artwork}')`;
                widget.load(trackUrl, { 
                    show_artwork: false,
                    color: '#ff5500',
                    auto_play: true
                });
            });
        });
    </script>
</body>
</html>